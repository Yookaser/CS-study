# Chapter6 교착 상태

[[_TOC_]]

## 1. 교착 상태의 개요

### 1. 교착 상태의 정의

- **교착 상태**
  - 2개 이상의 프로세스가 다른 프로세스의 작업이 끝나기만 기다리며 작업을 더 이상 진행하지 못하는 상태
  - 아사 현상과의 차이
    - 아사는 운영체제의 잘못된 정책으로 인해 특정 프로세스의 작업이 지연되는 문제
    - 교착 상태는 여러 프로세스가 작업을 하다보니 자연적으로 일어나는 문제
      - 따라서 운영체제가 감시하다가 해결해줘야 함
      - 단, 아사를 해결한 에이징, 정책 변경으로는 해결할 수 없음



### 2. 교착 상태의 발생

- **시스템 자원**에서
  - 다른 프로세스와 공유할 수 없는 자원을 사용할 때 발생
  - 어떤 프로세스가 임계구역으로 보호되는 프린터, 스캐너, CD 레코더 등 동시에 사용할 수 없는 시스템 자원을 할당받은 후 양보하지 않는 경우
- **공유 변수**에서
  - 공유 변수를 사용할 때 발생
  - 한 변수를 할당받은 상태에서 다른 변수를 기다리면 교착 상태가 발생함
- **응용 프로그램**에서
  - 데이터베이스 같은 응용 프로그램에서 발생
  - 데이터베이스는 데이터의 일관성을 유지하기 위해 잠금을 사용하는데, 이때 교착 상태가 발생할 수 있음



### 3. 자원 할당 그래프

- **자원 할당 그래프**
  - 프로세스가 어떤 자원을 사용중이고 어떤 자원을 기다리고 있는지 방향성 있는 그래프로 표현한 것
    - 어떤 프로세스가 어떤 자원을 기다리고 있는지 한 눈에 파악할 수 있음
  - 프로세스는 원, 자원은 사각형으로 표현
    - 자원을 사용하는 경우 자원으로부터 프로세스로 향하는 화살표로 표시
    - 프로세스가 자원을 기다리는 경우는 반대로 표시함
  - **다중 자원**
    - 여러 프로세스가 하나의 자원을 동시에 사용하는 경우
    - 수용할 수 있는 프로세스의 수를 작은 동그라미로 표현
  - 철학자 문제에서의 교착상태 발생하는 조건
    1. 철학자들은 서로 포크를 공유할 수 없음
       - 자원을 공유하지 못하면 교착 상태가 발생
    2. 각 철학자는 다른 철학자의 포크를 빼앗을 수 없음
       - 자원을 놓을때까지 기다려야 하므로 교착 상태가 발생
    3. 각 철학자는 왼쪽 포크를 잡은 채 오른쪽 포크를 기다림
       - 자원 하나를 잡은 상태에서 다른 자원을 기다리면 교착 상태가 발생
    4. 자원 할당 그래프가 원형
       - 자원을 요구하는 방향이 원을 이루면 양보하지 않기 때문에 교착 상태가 발생



## 2. 교착 상태 필요조건

- 필요조건
  - 아래 4가지 중 하나라도 충족하지 않으면 교착 상태가 발생하지 않음
  - **상호 배제**
    - 한 프로세스가 사용하는 자원은 다른 프로세스와 공유할 수 없는 배타적인 자원이어야 함
      - 배타적인 자원은 임계구역으로 보호되기 때문에 동시에 사용할 수 없음
  - **비선점**
    - 한 프로세스가 사용 중인 자원은 중간에 다른 프로세스가 빼앗을 수 없음
      - 자원을 빼앗을 수 없으면 일정 시간을 두고 공유해야 하지만 못 뺏으면 공유도 안된다는 의미
      - 상호 배제(배타적인 자원)라도 빼앗을 수 있으면 교착 상태에 빠지지 않을 수 있음
  - **점유와 대기**
    - 프로세스가 어떤 자원을 할당받은 상태에서 다른 자원을 기다리는 상태
    - 점유와 대기를 한다고 모두 교착 상태에 빠지는 것은 아님
  - **원형 대기**
    - 점유와 대기를 하는 프로세스 간의 관계가 원을 이루어야 함



### 2. 식사하는 철학자 문제와 교착 상태 필요조건

- 필요조건
  - **상호 배제**
    - 포크는 한 사람이 사용하면 다른 사람이 사용할 수 없음
  - **비선점**
    - 포크를 사용하면 다른 사람이 빼앗을 수 없음
  - **점유와 대기**
    - 포크를 점유한 상태에서 다른 포크를 기다림
  - **원형 대기**
    - 원을 이루어 선후 관계를 결정할 수 없어 문제가 계속 맴돔
    - 만약 원형이 아니여서 선후관계가 있었다면 교착 상태가 발생하지 않았음



## 3. 교착 상태 해결 방법

### 1. 교착 상태 해결 방법

- 교착 상태 해결 방법

  | 해결 방법      | 특징                                         |
  | -------------- | -------------------------------------------- |
  | 교착 상태 예방 | 교착 상태를 유발하는 네 가지 조건을 무력화   |
  | 교착 상태 회피 | 교착 상태가 발생하지 않는 수준으로 자원 할당 |
  | 교착 상태 검출 | 자원 할당 그래프를 사용하여 교착 상태를 발견 |
  | 교착 상태 회복 | 교착 상태를 검출한 후 해결                   |

  - **교착 상태 예방**
    - 교착 상태는 상호 배제, 비선점, 점유와 대기, 원형 대기라는 네 가지 조건을 동시에 충족해야 발생하므로 하나라도 예방하는 것
    - 실효성이 적어 잘 사용되지 않음
  - **교착 상태 회피**
    - 자원을 할당하다가 교착 상태가 발생할 수 있다고 판단되면 자원 할당을 중지함
    - 얼마만큼 자원을 할당해야 교착 상태가 발생하는지 보장이 없으므로 실효성이 적음
  - **교착 상태 검출과 회복**
    - 어떤 제약을 가하지 않고 자원 할당 그래프를 모니터링하며 자원 할당 그래프를 모니터링
    - 교착 상태가 발생하면 교착 상태 회복 단계가 진행
    - 가장 현실적인 접근 방법



### 2. 교착 상태 예방

#### 2.1 상호 배제 예방

- 방법
  - 시스템 내 상호 배타적 자원(독점적 자원)을 없애버리는 것(모두 공유함)



- 제약
  - 모든 자원을 공유할 수 없음(ex - 임계구역)



#### 2.2 비선점 예방

- 방법
  - 모든 자원을 서로 빼앗을 수 있게 만듬



- 제약
  - 임계구역을 보호하기 위해 잠금을 사용해야 하므로 빼앗을 수 없고 상호 배제도 보장하지 못함
  - 자원을 빼앗더라도 어떤 기준으로 빼앗을지, 얼마나 사용할지를 설정하기 정하기 어려움
    - 아사 현상을 만들 게 될 것임(ex - 우선순위 높은 프로세스가 계속 자원을 사용함)
      - 에이징을 구현해도 결국 비선점 조건을 무력화하기 어려움
        - 낮은 우선순위 프로세스가 N번 양보 끝에 무조건 사용하는 경우를 고려



#### 2.3 점유와 대기 예방

- 방법
  - 프로세스가 자원을 점유한 상태에서 다른 자원을 기다리지 못하게 하는 방법
    - 즉, 전부 할당하거나 아니면 아예 할당하지 않는 방식



- 제약
  - 프로세스는 자신이 사용하는 모든 자원을 자세히 알기 어려움
    - 프로세스 실행 후 추가 필요 자원이 생길 수 있음
  - 자원의 활용성이 떨어짐
    - 앞으로 사용할 자원까지 모두 선점하기 때문에 자원 낭비가 심함
  - 많은 자원을 사용하는 프로세스가 적은 자원을 사용하는 프로세스보다 불리함
    - 자원을 많이 사용하면 해당 자원을 확보하기 어려움 => 아사 현상 발생
  - 결국 일괄 작업 방식으로 동작함
    - 예를 들어 키보드, 마우스 등은 대부분의 프로세스가 필요로 하는데, 이러한 자원을 확보한 순서대로 실행하면 그 자원을 획득한 프로세스가 끝나여 다른 프로세스가 작업함
    - 즉, 이런 상황때문에 일괄 작업 방식으로 처리됨



#### 2.4 원형 대기 예방

- 방법
  - 점유와 대기를 하는 프로세스들이 원형을 이루지 못하게 한 줄로 길게 늘어섬
    - 모든 자원에 숫자를 부여하고 숫자가 큰 방향으로만 자원을 할당
    - 즉, 숫자가 작은 자원을 잡은 상태에서 큰 자원을 잡는 것은 허용하지만, 숫자가 큰 자원을 잡은 상태에서 작은 숫자를 잡는 것은 허용하지 않음
      - 예를 들어 마우스 1번, 하드디스크 2번, 프린터 3번
        - 마우스를 할당받은 상태에서 프린터를 할당 받는 것은 가능하지만 반대는 불가능
  - 모든 자원을 할당받아야 할 수 있는 점유와 대기보다 완화된 방법



- 제약
  - 프로세스 작업 진행의 유연성이 떨어짐
    - 사용자가 프린터를 사용한 다음 마우스를 할당받으려면 운영체제가 이를 거부함
    - 즉, 사용자는 이런 자원 사용을 납득하기 어려움
  - 자원의 번호를 어떻게 부여할 것인지가 문제
    - 자원에 번호를 어떻게 붙이든 자원 사용제 제약이 따름



#### 2.5 교착 상태 예방 정리

- 상호 배제와 비선점은 자원을 보호하기 위해 예방하기 어려움
- 점유와 대기, 원형 대기는 작업 방식을 제약하고 자원을 낭비하기 때문에 사용하기 어려움



### 3. 교착 상태 회피

#### 3.1 교착 상태 회피의 개념

- 교착 상태 회피
  - 자원의 총수와 현재 할당된 자원의 수를 기준으로 시스템을 안정 상태와 불안정 상태로 나누고 시스템이 안정 상태를 유지하도록 자원을 할당
    - 교착 상태 발생이 예상되면 해당 프로세스를 대기시킴
    - 할당된 자원이 적을수록 안정 상태가 큼
    - 불안정 상태라고 교착 상태가 아님(불안정 상태 > 교착 상태)
  - 시스템 운영 방식에 변경을 가하지 않기 때문에 교착 상태 예방보다 유연함



#### 3.2 은행원 알고리즘

- **은행원 알고리즘**

  - 각 프로세스는 자신이 사용할 자원의 최대 수를 운영체제에 알려줌

    | 변수                  | 설명                                                         |
    | --------------------- | ------------------------------------------------------------ |
    | 전체 자원(Total)      | 시스템 내 전체 자원의 수                                     |
    | 가용 자원(Available)  | 시스템 내 현재 사용할 수 있는 자원의 수(전체 자원 - 모든 할당 자원) |
    | 최대 자원(Max)        | 각 프로세스가 선언한 최대 자원의 수                          |
    | 할당 자원(Allocation) | 각 프로세스에 현재 할당된 자원의 수                          |
    | 기대 자원(Except)     | 각 프로세스가 앞으로 사용할 자원의 수(최대 자원 - 할당 자원) |

  - 자원 할당의 기준

    - 각 프로세스의 기대 자원과 비교하여 가용 자원이 하나라도 크거나 같으면 자원을 할당
      - 가용 자원이 기대 자원보다 크다는 것은 그 자원을 사용하여 작업을 끝낼 수 있는 프로세스가 있다는 의미
    - 가용 자원이 어떤 기대 자원보다 크지 않으면 할당하지 않음
      - 가용 자원을 사용하여 작업을 마칠 수 있는 프로세스가 없다는 의미이므로 불안정 상태

  - **안정 상태**

    - 각 프로세스의 기대 자원과 비교하여 가용 자원이 크거나 같은 경우가 한 번 이상이 경우



#### 3.3 교착 상태 회피의 문제점

- 아래의 문제로 인해 교착 상태 회피는 잘 사용되지 않음
  - 프로세스가 자신이 사용할 모든 자원을 미리 선언해야 함
    - 프로세스가 자신이 사용할 모든 자원을 파악하기 쉽지 않음
    - 따라서 부정확한 경우 교착 상태가 발생할 수 있음
  - 시스템의 전체 자원수가 고정적이어야 함
    - 일반적으로 일시적 고장이나 새로운 자원이 추가되는 일이 빈번하므로 시스템 자원수가 유동적임
  - 자원이 낭비됨
    - 모든 불안정 상태가 교착 상태가 되는 것이 아님에도 자원을 할당하지 않는 것은 낭비임



### 4. 교착 상태 검출

#### 4.1 교착 상태 검출의 개념

- 정리
  - 교착 상태 예방 - 구현이 어려움
  - 교착 상태 회피 - 자원 낭비



- 교착 상태 검출
  - 운영체제가 프로세스의 작업을 관찰하면서 교착 상태 여부를 계속 주시하는 방식
  - 교착 상태가 발견되면 회복의 절차를 밟음



#### 4.2 타임아웃을 이용한 교착 상태 검출

- 방법
  - 일정 시간 동안 작업이 진행되지 않은 프로세스를 교착 상태가 발생한 것으로 간주하고 처리하는 방법
  - 교착 상태가 자주 발생하지 않을 것이라 가정하에 사용하는 것



- 제약

  - 엉뚱한 프로세스가 강제 종료될 수 있음
    - 타임아웃 시간 동안 진행되지 않은 모든 프로세스가 교착 상태에 빠진 것은 아님

  - 모든 시스템에 적용할 수 없음
    - 하나의 운영체제 내에서 동작하는 프로세스들은 그 상태를 운영체제가 감시하기 때문에 타임아웃 방법을 적용할 수 있음
    - 여러 군데에 데이터가 나뉘어 있는 분산 데이터베이스의 경우에는 타임아웃을 이용하는 방법을 적용하기 어려움
      - 예를 들어 분산 데이터베이스 시스템에서 프로세스가 응답이 없는 것이 교착 때문인지, 네트워크 문제 때문인지, 단순히 처리가 늦는 것인지 구분할 수 없음



- 여러 제약이 있음에도 데이터베이스와 운영체제에서 많이 선호됨
  - 자원 할당 그래프를 이용하여 교착 상태를 찾기 위해 자원 할당 그래프를 유지하면서 모든 자원을 감시하기 어렵기 때문
    - 따라서 타임아웃을 이용하는 방법을 **가벼운 교착 상태 검출**
    - 자원 할당 그래프를 이용하는 방법을 **무거운 교착 상태 검출**



- 데이터베이스에서의 교착 상태 처리
  - 데이터베이스는 일관성이 깨지면 안됨
    - 데이터 조작할 때는 반드시 잠금을 얻은 후 작업을 시작
    - 만약 여러 개의 잠금을 얻어 작업을 하던 중 타임아웃으로 프로세스가 종료되면 일부 데이터에 문제가 발생할  수 있음
  - 일관성을 유지하기 위해 **체크포인트**와 **롤백**을 사용
    - 체크포인트: 작업을 하다가 문제가 발생하면 저장된 상태로 돌아오기 위한 표시
      - 현재의 시스템 상태가 하드디스크에 저장됨(**스냅숏**)
    - 롤백: 저장된 스냅숏을 복원하고 시스템을 체크포인트 시점으로 되돌림



#### 4.3 자원 할당 그래프를 이용한 교착 상태 검출

- 자원 할당 그래프
  - 시스템 내의 프로세스가 어떤 자원을 사용하고 있는지 혹은 기다리고 있는지 알 수 있음
  - 단일 자원을 사용하는 경우 자원 할당 그래프에 사이클 있으면 교착 상태
  - 그러나 다중 지원을 사용하는 경우에는 자원 할당 그래프에 사이클이 있다고 교착이라 판단할 수 없음
  - 장점
    - 프로세스의 작업 방식을 제한하지 않으면서 교착 상태를 정확하게 파악할 수 있음
  - 단점
    - 그래프를 유지, 갱신, 사이클 검사의 추가 작업으로 인해 오버헤드가 발생
      - 추가 작업을 줄이기 위해 자원 할당마다가 아닌 일정 시간마다 사이클 검사할 수 있음



### 5. 교착 상태 회복

- 교착 상태 회복
  - 교착 상태가 검출되면 교착 상태를 푸는 작업으로 교착 상태를 유발한 프로세스를 강제 종료함
  - 종류
    - 교착 상태를 일으킨 모든 프로세스를 동시에 종료
      - 종료된 프로세스들이 동시에 작업을 시작하면 다시 교착 상태를 일으킬 가능성이 큼
      - 그러므로 모든 프로세스를 순차적으로 실행해야 하며 기준이 필요함
    - 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료
      - 교착 상태를 유발한 프로세스를 하나씩 종료하며 상태를 파악하는 방법
      - 기준
        - 우선순위가 낮은 프로세스를 먼저 종료
        - 우선순위가 같은 경우 작업 시간이 짧은 프로세스를 먼저 종료
        - 위의 두 조건이 같은 경우 자원을 많이 사용하는 프로세스를 먼저 종료
  - 이 단계에서 강제 종료뿐만 아니라 강제 종료된 프로세스가 실행되기 전에 시스템 복구하는 일도 해야함
    - 시스템 복구는 명령어가 실행될 때마다 체크포인터를 만들어 가장 최근의 검사 시점으로 돌아가는 방식으로 함
      - 이 방법은 작업량이 상당하여 시스템에 부하를 주므로 체크포인터를 무분별하게 사용하지 말고 선택적으로 해야 함



## 4. [심화학습] 다중 지원과 교착 상태 검출

- 단일 자원이면 사이클이 존재하면 교착 상태이지만, 다중 자원에서는 검출이 복잡함



### 1. 다중 지원과 사이클

- 사이클
  - 사이클이 있더라고 교착상태인지 아닌지 모름
  - 각 자원을 사용하고 반납한 뒤, 상대방 프로세스의 자원을 사용해 작업을 마칠 수 있음



### 2. 대기 그래프와 그래프 감소

- **대기 그래프**
  - 자원 할당 그래프에서 프로세스와 프로세스 간에 기다리는 관계만 나타낸 그래프



- **그래프 감소**
  - 대기 그래프에서 작업이 끝날 가능성이 있는 프로세스의 화살표와 관련 프로세스의 화살표를 연속적으로 지워가는 작업
    - 작업이 끝날 가능성이 있는 프로세스란 기다리는 자원이 없는 프로세스를 가리킴
    - 그래프 감소를 완료한 후에도 사이클이 남아 있다면 교착 상태가 발생한 것으로 판단함

